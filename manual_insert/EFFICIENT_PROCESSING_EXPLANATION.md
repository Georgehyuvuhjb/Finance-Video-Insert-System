# é«˜æ•ˆè¦–é »è™•ç†æŠ€è¡“èªªæ˜

## å•é¡Œåˆ†æ

æ‚¨æå‡ºçš„å•é¡Œéå¸¸é—œéµï¼š**ç‚ºä»€éº¼éœ€è¦è®€å–æ•´éƒ¨å½±ç‰‡æ‰èƒ½å¯«å…¥ä¸€å°æ®µå½±ç‰‡ï¼Ÿ**

### å‚³çµ±æ–¹æ³•çš„å•é¡Œ

åŸæœ‰çš„ PyTorch æ–¹æ³•å­˜åœ¨åš´é‡çš„è¨˜æ†¶é«”æµªè²»ï¼š

```
å‚³çµ±æ–¹æ³•æµç¨‹ï¼š
1. è®€å–æ•´éƒ¨ 4K å½±ç‰‡åˆ°è¨˜æ†¶é«” (77+ å°æ™‚å½±ç‰‡ = 180GB è¨˜æ†¶é«”)
2. è®€å–è¦†è“‹å½±ç‰‡åˆ°è¨˜æ†¶é«” (3ç§’ç‰‡æ®µ = å¹¾ç™¾MB)
3. åœ¨è¨˜æ†¶é«”ä¸­è™•ç† 3 ç§’çš„è¦†è“‹
4. å¯«å‡ºæ•´éƒ¨è™•ç†å¾Œçš„å½±ç‰‡

å•é¡Œï¼šç‚ºäº†è™•ç† 3 ç§’çš„è¦†è“‹ï¼Œéœ€è¦ 180GB è¨˜æ†¶é«”ï¼
```

## è§£æ±ºæ–¹æ¡ˆï¼šç‰‡æ®µè™•ç†æŠ€è¡“

### é«˜æ•ˆæ–¹æ³•åŸç†

æ–°çš„ç‰‡æ®µè™•ç†æ–¹æ³•ï¼š

```
é«˜æ•ˆæ–¹æ³•æµç¨‹ï¼š
1. åˆ†æé…ç½®ï¼Œæ‰¾å‡ºéœ€è¦ä¿®æ”¹çš„æ™‚é–“ç‰‡æ®µ (ä¾‹å¦‚ 0.05ç§’-3.05ç§’)
2. è¤‡è£½ 0-0.05ç§’ çš„åŸå§‹å½±ç‰‡ (ç›´æ¥ I/Oï¼Œç„¡è¨˜æ†¶é«”è¼‰å…¥)
3. è¼‰å…¥ä¸¦è™•ç† 0.05-3.05ç§’ ç‰‡æ®µ (åªéœ€è¦ 3ç§’å½±ç‰‡çš„è¨˜æ†¶é«”)
4. è¤‡è£½ 3.05ç§’-çµå°¾ çš„åŸå§‹å½±ç‰‡ (ç›´æ¥ I/Oï¼Œç„¡è¨˜æ†¶é«”è¼‰å…¥)

è¨˜æ†¶é«”éœ€æ±‚ï¼šåªéœ€è¦ 3 ç§’å½±ç‰‡çš„è¨˜æ†¶é«” (~å¹¾ç™¾MB)
```

### è¨˜æ†¶é«”ç¯€çœæ•ˆæœ

å°æ–¼æ‚¨çš„ä½¿ç”¨æ¡ˆä¾‹ï¼š
- **åŸæ–¹æ³•**: 180GB è¨˜æ†¶é«”éœ€æ±‚
- **æ–°æ–¹æ³•**: ~500MB è¨˜æ†¶é«”éœ€æ±‚  
- **ç¯€çœ**: 99.7% è¨˜æ†¶é«”ç¯€çœ

### æŠ€è¡“å¯¦ç¾

#### 1. ç‰‡æ®µåˆ†æ
```python
def _analyze_overlay_segments(self, overlay_configs, fps, total_frames):
    # åˆ†ææ‰€æœ‰è¦†è“‹æ“ä½œï¼Œæ‰¾å‡ºéœ€è¦ä¿®æ”¹çš„å¹€ç¯„åœ
    segments = []
    for config in overlay_configs:
        start_frame = int(config['start_time'] * fps)
        end_frame = start_frame + int(config['duration'] * fps)
        segments.append({'start': start_frame, 'end': end_frame, 'config': config})
    return segments
```

#### 2. ç›´æ¥è¤‡è£½æœªä¿®æ”¹ç‰‡æ®µ
```python
def _copy_video_segment_cv2(self, cap, out, start_frame, end_frame):
    # ç›´æ¥å¾è¼¸å…¥è¤‡è£½åˆ°è¼¸å‡ºï¼Œç„¡è¨˜æ†¶é«”è¼‰å…¥
    for frame_idx in range(start_frame, end_frame):
        ret, frame = cap.read()
        out.write(frame)  # ç›´æ¥å¯«å…¥ï¼Œä¸å­˜å„²åœ¨è¨˜æ†¶é«”
```

#### 3. åªè™•ç†éœ€è¦ä¿®æ”¹çš„ç‰‡æ®µ
```python
def _process_overlay_segment_cv2(self, cap, out, segment, width, height, fps):
    # åªè¼‰å…¥è¦†è“‹å½±ç‰‡çš„å¿…è¦å¹€
    overlay_frames = self._load_overlay_frames_cv2(...)  # å°è¨˜æ†¶é«”éœ€æ±‚
    
    # é€å¹€è™•ç†ä¸¦ç«‹å³å¯«å‡º
    for frame_idx in range(segment['start'], segment['end']):
        main_frame = cap.read()  # è®€ä¸€å¹€
        # æ‡‰ç”¨è¦†è“‹
        main_frame[y:y+h, x:x+w] = overlay_frame
        out.write(main_frame)    # å¯«ä¸€å¹€ï¼Œé‡‹æ”¾è¨˜æ†¶é«”
```

## æ•ˆèƒ½å„ªå‹¢

### 1. è¨˜æ†¶é«”æ•ˆç‡
- **å‚³çµ±**: O(æ•´éƒ¨å½±ç‰‡å¤§å°)
- **æ–°æ–¹æ³•**: O(è¦†è“‹ç‰‡æ®µå¤§å°)

### 2. è™•ç†é€Ÿåº¦
- **å‚³çµ±**: éœ€è¦è™•ç†æ¯ä¸€å¹€
- **æ–°æ–¹æ³•**: åªè™•ç†éœ€è¦ä¿®æ”¹çš„å¹€ï¼Œå…¶ä»–ç›´æ¥è¤‡è£½

### 3. é©ç”¨æ€§
- **4K é•·å½±ç‰‡**: å¾ä¸å¯è¡Œè®Šç‚ºå¯è¡Œ
- **å¤šå€‹å°è¦†è“‹**: æ¥µå¤§æå‡æ•ˆç‡
- **HPC ç’°å¢ƒ**: é©åˆè¨˜æ†¶é«”å—é™çš„ç’°å¢ƒ

## å¯¦éš›ä½¿ç”¨æ•ˆæœ

å°æ–¼æ‚¨çš„å‘½ä»¤ï¼š
```bash
python main.py manual-insert -- \
  --input-video outputs/final.mp4 \
  --output outputs/s1.mp4 \
  --add-video outputs/videos/172894_finance_large.mp4 \
  --insert-time "00:00.05" \
  --clip-start "00:03.00" \
  --position "75%,50%" \
  --size "46%"
```

**èˆŠæ–¹æ³•è¨˜æ†¶é«”éœ€æ±‚**: 
- ä¸»å½±ç‰‡: ~180GB (4K, 77å°æ™‚)
- è¦†è“‹å½±ç‰‡: ~500MB (3ç§’)
- ç¸½è¨ˆ: 180.5GB

**æ–°æ–¹æ³•è¨˜æ†¶é«”éœ€æ±‚**:
- è™•ç†ç‰‡æ®µ: ~500MB (åªéœ€è¦ 3 ç§’çš„ä¸»å½±ç‰‡ + è¦†è“‹å½±ç‰‡)
- å…¶ä»–éƒ¨åˆ†: 0MB (ç›´æ¥è¤‡è£½ï¼Œä¸è¼‰å…¥è¨˜æ†¶é«”)
- ç¸½è¨ˆ: 500MB

## é…ç½®é¸é …

å¯ä»¥é¸æ“‡è™•ç†æ¨¡å¼ï¼š

```python
# å•Ÿç”¨ç‰‡æ®µè™•ç† (æ¨è–¦)
inserter = ManualVideoInserter(use_segment_processing=True)

# ä½¿ç”¨å‚³çµ±å…¨é‡è™•ç†
inserter = ManualVideoInserter(use_segment_processing=False)
```

ç³»çµ±æœƒè‡ªå‹•é¡¯ç¤ºè¨˜æ†¶é«”ç¯€çœæ•ˆæœï¼š
```
ğŸ’¡ Memory optimization: Only processing 89/1946 frames (95.4% memory saved)
```

é€™ç¨®æ–¹æ³•è§£æ±ºäº†æ‚¨æå‡ºçš„æ ¸å¿ƒå•é¡Œï¼š**ä¸å†éœ€è¦è¼‰å…¥æ•´éƒ¨å½±ç‰‡ä¾†è™•ç†å°ç‰‡æ®µè¦†è“‹**ã€‚
